/*
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

@title: Sandbox
@author: Marceloni
@tags: []
@addedOn: 2024-00-00
*/

const selectionBox = "<"
const selectionBox2 = ">"
const black = "B"
const gray = "z"
const lightGray = "Z"
const white = "w"
const red = "r"
const brown = "b"
const lightBlue = "L"
const blue = "l"
const yellow = "y"
const olive = "o"
const lime = "m"
const green = "g"
const pink = "p"
const purple = "u"
const orange = "n"

setLegend(
  [selectionBox, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  [selectionBox2, bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  [black, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  [gray, bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  [lightGray, bitmap`
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111`],
  [white, bitmap`
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222`],
  [red, bitmap`
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333`],
  [brown, bitmap`
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC`],
  [lightBlue, bitmap`
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777`],
  [blue, bitmap`
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555`],
  [yellow, bitmap`
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666`],
  [olive, bitmap`
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF`],
  [lime, bitmap`
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444`],
  [green, bitmap`
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD`],
  [pink, bitmap`
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888`],
  [purple, bitmap`
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH`],
  [orange, bitmap`
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999`]
)

setSolids([black, gray, lightGray, white, red, brown, lightBlue, blue, yellow, olive, lime, green, pink, purple, orange])

const emptyMap = map`
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................`
setMap(emptyMap)



class Stone {
  colors = [gray, lightGray]
  hasStepped = false
  constructor(x, y) {
    this.x = x
    this.y = y
    this.color = this.colors[(x+y)%this.colors.length]
  }
  step() {}
}

class Water {
  colors = [blue, lightBlue]
  hasStepped = false
  constructor(x, y) {
    this.x = x
    this.y = y
    this.color = this.colors[(x+y)%this.colors.length]
  }
  step() {
    this.hasStepped = true
    if(this.y<height()-8 && cellGrid[this.x][this.y+1] == undefined){
      cellGrid[this.x][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.color = this.colors[(this.x+this.y)%this.colors.length]
    }else if(this.y<height()-8 && this.x>0 && cellGrid[this.x-1][this.y+1] == undefined ) {
      cellGrid[this.x-1][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.x--
      this.color = this.colors[(this.x+this.y)%this.colors.length]
    }else if(this.y<height()-8 && this.x<width()-1 && cellGrid[this.x+1][this.y+1] == undefined) {
      cellGrid[this.x+1][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.x++
      this.color = this.colors[(this.x+this.y)%this.colors.length]
    }else {
      let spaceLeft = this.x>0 ? cellGrid[this.x-1][this.y] == undefined : false
      let spaceRight = this.x<width()-1 ? cellGrid[this.x+1][this.y] == undefined : false

      if(spaceLeft && spaceRight){
        if(Math.random() < 0.5){spaceLeft=false}else{spaceRight=false}
      }
      if(spaceLeft){
        cellGrid[this.x-1][this.y] = cellGrid[this.x][this.y]
        cellGrid[this.x][this.y] = undefined
        this.x--
        this.color = this.colors[(this.x+this.y)%this.colors.length]
      }if(spaceRight){
        cellGrid[this.x+1][this.y] = cellGrid[this.x][this.y]
        cellGrid[this.x][this.y] = undefined
        this.x++
        this.color = this.colors[(this.x+this.y)%this.colors.length]
      }
    }
  }
}

function checkLastAvailableSpot(x, y, length, direction){
  let lastSpot = 0
  for(var i = 1; i <= length; i++){
    if(direction){
      if(x+i < width() && cellGrid[x+i][y]==undefined){lastSpot = i}else {break}
    }else {
      if(x-i >= 0 && cellGrid[x-i][y]==undefined){lastSpot = i}else {break}
    }
  }
  return lastSpot
}

class Sand {
  colors = [yellow, olive, orange]
  hasStepped = false
  constructor(x, y) {
    this.x = x
    this.y = y
    this.color = this.colors[(x+y)%this.colors.length]
  }
  step() {
    this.hasStepped = true
    if(this.y<height()-8 && cellGrid[this.x][this.y+1] == undefined){
      cellGrid[this.x][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      //this.color = this.colors[(this.x+this.y)%this.colors.length]
    }else if(this.y<height()-8 && this.x>0 && cellGrid[this.x-1][this.y+1] == undefined ) {
      cellGrid[this.x-1][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.x--
      //this.color = this.colors[(this.x+this.y)%this.colors.length]
    }else if(this.y<height()-8 && this.x<width()-1 && cellGrid[this.x+1][this.y+1] == undefined) {
      cellGrid[this.x+1][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.x++
      //this.color = this.colors[(this.x+this.y)%this.colors.length]
    }
  }
}

let cellTypes = {
  "Sand": {class: Sand, mainColor: yellow},
  "Stone": {class: Stone, mainColor: gray},
  "Water": {class: Water, mainColor: lightBlue}
}
let selectedCellType = "Stone"

let selectionBoxPosition = {x: 80, y: 64}
let brushSize = 1
const selectionSpeed = 1

onInput("w", () => {
  selectionBoxPosition.y -= selectionSpeed
  redrawSelectionBox()
})
onInput("a", () => {
  selectionBoxPosition.x -= selectionSpeed
  redrawSelectionBox()
})
onInput("s", () => {
  selectionBoxPosition.y += selectionSpeed
  redrawSelectionBox()
})
onInput("d", () => {
  selectionBoxPosition.x += selectionSpeed
  redrawSelectionBox()
})


onInput("j", ()=> {
  let brushSizes = [1, 2, 3, 5, 10, 20]
  brushSize = brushSizes[(brushSizes.indexOf(brushSize)+1)%(brushSizes.length)]
  redrawUI()
  redrawSelectionBox()
})
onInput("k", ()=> {
  drawBrush()
})
onInput("l", ()=> {
  let cellTypesKeys = Object.keys(cellTypes)
  selectedCellType = cellTypesKeys[(cellTypesKeys.indexOf(selectedCellType)+1) % cellTypesKeys.length];
  redrawUI()
})


let selectionBoxPixels = []
function redrawSelectionBox() {
  selectionBoxPosition.x = Math.min(Math.max(selectionBoxPosition.x, 0), width()-brushSize-2)
  selectionBoxPosition.y = Math.min(Math.max(selectionBoxPosition.y, 0), height()-brushSize-2-7)
  
  selectionBoxPixels = []
  getAll(selectionBox).forEach((sprite)=>{sprite.remove()})
  getAll(selectionBox2).forEach((sprite)=>{sprite.remove()})
  
  for (let i = 0; i <= brushSize+1; i++) {
    for (let j = 0; j <= brushSize+1; j++) {
      if(i < 1 || i >= brushSize+1 || j < 1 || j >= brushSize+1) {
        selectionBoxPixels.push({x: selectionBoxPosition.x + i, y: selectionBoxPosition.y + j})
        addSprite(selectionBoxPosition.x + i, selectionBoxPosition.y+7 + j, selectionBox)
      }
    }
  }
}

function redrawUI() {
  clearText()
  addText("Brush:"+brushSize, { x: 14-String(brushSize).length, y: 0, color: color`9` })
  drawRect(0, 0, 7, 7, cellTypes[selectedCellType].mainColor, 1, black, true)
  addText(selectedCellType, { x: 1, y:0, color: color`9`})
}

function drawRect(x, y, sizeX, sizeY, fillType, borderWidth, borderType, clear) {
 for (let i = 0; i <= sizeX-1; i++) {
    for (let j = 0; j <= sizeY-1; j++) {
      clearTile(x+i, y+j)
      if(i < borderWidth || i >= sizeX-borderWidth || j < borderWidth || j >= sizeY-borderWidth) {
        if(borderType){addSprite(x + i, y + j, borderType)}
      }else {
        if(fillType){addSprite(x + i, y + j, fillType)}
      }
    }
  }
}

function drawBrush() {
 for (let i = 1; i <= brushSize; i++) {
    for (let j = 1; j <= brushSize; j++) {
      cellGrid[selectionBoxPosition.x+i][selectionBoxPosition.y+j] = new cellTypes[selectedCellType].class(selectionBoxPosition.x+i, selectionBoxPosition.y+j)
    }
  }
}


let oldCellGrid = new Array(width())
let cellGrid = new Array(width())
for (var i = 0; i < cellGrid.length; i++) {
  oldCellGrid[i] = new Array(height()-7)
  cellGrid[i] = new Array(height()-7)
}

setInterval(()=>{
  stepCells()
}, 0)



function moveCell(oldX, oldY, newX, newY) {
  cellGrid[newX][newY] = cellGrid[oldX][oldY]
  cellGrid[oldX][oldY] = undefined
  cellGrid[newX][newY].x = newX
  cellGrid[newX][newY].y = newY
}



function stepCells() {
  for (var x = 0; x < cellGrid.length; x++) {
    for (var y = cellGrid[x].length; y >= 0; y--) {
      if((!cellGrid[x][y] ^ !oldCellGrid[x][y]) || cellGrid[x][y]?.type!=oldCellGrid[x][y]?.type || cellGrid[x][y]?.color!=oldCellGrid[x][y]?.color){
        oldCellGrid[x][y] = cellGrid[x][y]
        clearTile(x, y+7)
        
        if(cellGrid[x][y]!=undefined){
          addSprite(x, y+7, cellGrid[x][y].color)
        }

        if(selectionBoxPixels.some(e=>e.x==x&&e.y==y)){
          addSprite(x, y+7, selectionBox)
        }
      }
    }
  }
  for (var x = 0; x < cellGrid.length; x++) {
    for (var y = cellGrid[x].length; y >= 0; y--) {
      if(cellGrid[x][y]!=undefined && !cellGrid[x][y].hasStepped){
        cellGrid[x][y].step()
      }
    }
  }
  for (var x = 0; x < cellGrid.length; x++) {
    for (var y = cellGrid[x].length; y >= 0; y--) {
      if(cellGrid[x][y]!=undefined){
        cellGrid[x][y].hasStepped = false
      }
    }
  }
}

redrawSelectionBox()
redrawUI()
