/*
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

@title: 
@author: 
@tags: []
@addedOn: 2024-00-00
*/

const selectionBox = "<"
const selectionBox2 = ">"
const black = "B"
const gray = "y"
const lightGray = "Y"
const white = "w"
const red = "r"
const brown = "b"
const lightBlue = "L"
const blue = "l"
const yellow = "y"
const olive = "o"
const lime = "m"
const green = "g"
const pink = "p"
const purple = "u"
const orange = "n"

setLegend(
  [selectionBox, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  [selectionBox2, bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  [black, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  [gray, bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  [lightGray, bitmap`
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111
1111111111111111`],
  [white, bitmap`
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222`],
  [red, bitmap`
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333`],
  [brown, bitmap`
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCC`],
  [lightBlue, bitmap`
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777
7777777777777777`],
  [blue, bitmap`
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555`],
  [yellow, bitmap`
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666`],
  [olive, bitmap`
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF`],
  [lime, bitmap`
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444
4444444444444444`],
  [green, bitmap`
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD
DDDDDDDDDDDDDDDD`],
  [pink, bitmap`
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888
8888888888888888`],
  [purple, bitmap`
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH
HHHHHHHHHHHHHHHH`],
  [orange, bitmap`
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999
9999999999999999`]
)

setSolids([black, gray, lightGray, white, red, brown, lightBlue, blue, yellow, olive, lime, green, pink, purple, orange])

const emptyMap = map`
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................`
setMap(emptyMap)



class Stone {
  constructor(x, y) {
    this.x = x
    this.y = y
    this.colors = [gray, lightGray]
    this.color = this.colors[(x+y)%this.colors.length]
  }
  step() {}
}

class Sand {
  constructor(x, y) {
    this.x = x
    this.y = y
    this.colors = [yellow, olive, orange]
    this.color = this.colors[(x+y)%this.colors.length]
  }
  step() {
    if(this.y<height()-8 && cellGrid[this.x][this.y+1] == undefined){
      cellGrid[this.x][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.color = this.colors[(this.x+this.y)%this.colors.length]
      console.log("test")
    }else if(this.y<height()-8 && this.x>0 && cellGrid[this.x-1][this.y+1] == undefined ) {
      cellGrid[this.x-1][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.x--
      this.color = this.colors[(this.x+this.y)%this.colors.length]
    }else if(this.y<height()-8 && this.x<width()-1 && cellGrid[this.x+1][this.y+1] == undefined) {
      cellGrid[this.x+1][this.y+1] = cellGrid[this.x][this.y]
      cellGrid[this.x][this.y] = undefined
      this.y++
      this.x++
      this.color = this.colors[(this.x+this.y)%this.colors.length]
    }
  }
}

let cellTypes = {
  "sand": Sand,
  "stone": Stone
}
let selectedCellType = "stone"

let selectionBoxPosition = {x: 80, y: 64}
let brushSize = 1
const selectionSpeed = 1

onInput("w", () => {
  selectionBoxPosition.y -= selectionSpeed
  redrawSelectionBox()
})
onInput("a", () => {
  selectionBoxPosition.x -= selectionSpeed
  redrawSelectionBox()
})
onInput("s", () => {
  selectionBoxPosition.y += selectionSpeed
  redrawSelectionBox()
})
onInput("d", () => {
  selectionBoxPosition.x += selectionSpeed
  redrawSelectionBox()
})


onInput("j", ()=> {
  let brushSizes = [1, 2, 3, 5, 10, 20]
  brushSize = brushSizes[(brushSizes.indexOf(brushSize)+1)%(brushSizes.length)]
  redrawUI()
  redrawSelectionBox()
})
onInput("k", ()=> {
  drawBrush()
})


let selectionBoxPixels = []
function redrawSelectionBox() {
  selectionBoxPosition.x = Math.min(Math.max(selectionBoxPosition.x, 0), width()-brushSize-2)
  selectionBoxPosition.y = Math.min(Math.max(selectionBoxPosition.y, 0), height()-brushSize-2-7)
  
  selectionBoxPixels = []
  getAll(selectionBox).forEach((sprite)=>{sprite.remove()})
  getAll(selectionBox2).forEach((sprite)=>{sprite.remove()})
  
  for (let i = 0; i <= brushSize+1; i++) {
    for (let j = 0; j <= brushSize+1; j++) {
      if(i < 1 || i >= brushSize+1 || j < 1 || j >= brushSize+1) {
        selectionBoxPixels.push({x: selectionBoxPosition.x + i, y: selectionBoxPosition.y + j})
        addSprite(selectionBoxPosition.x + i, selectionBoxPosition.y+7 + j, selectionBox)
      }
    }
  }
}

function redrawUI() {
  clearText()
  addText("Brush:"+brushSize, { x: 14-String(brushSize).length, y: 0, color: color`9` })
  drawRect(0, 0, 7, 7, yellow, 1, black)
  addText(selectedCellType, { x: 1, y:0, color: color`9`})
}

function drawRect(x, y, sizeX, sizeY, fillType, borderWidth, borderType) {
 for (let i = 0; i <= sizeX-1; i++) {
    for (let j = 0; j <= sizeY-1; j++) {
      if(i < borderWidth || i >= sizeX-borderWidth || j < borderWidth || j >= sizeY-borderWidth) {
        if(borderType){addSprite(x + i, y + j, borderType)}
      }else {
        if(fillType){addSprite(x + i, y + j, fillType)}
      }
    }
  }
}

function drawBrush() {
 for (let i = 1; i <= brushSize; i++) {
    for (let j = 1; j <= brushSize; j++) {
      cellGrid[selectionBoxPosition.x+i][selectionBoxPosition.y+j] = new cellTypes[selectedCellType](selectionBoxPosition.x+i, selectionBoxPosition.y+j)
    }
  }
}


let oldCellGrid = new Array(width())
let cellGrid = new Array(width())
for (var i = 0; i < cellGrid.length; i++) {
  oldCellGrid[i] = new Array(height()-7)
  cellGrid[i] = new Array(height()-7)
}

setInterval(()=>{
  for (var x = 0; x < cellGrid.length; x++) {
    for (var y = cellGrid[x].length; y >= 0; y--) {
      if((!cellGrid[x][y] ^ !oldCellGrid[x][y]) || cellGrid[x][y]?.type!=oldCellGrid[x][y]?.type){
        oldCellGrid[x][y] = cellGrid[x][y]
        clearTile(x, y+7)
        selectionBoxPosition.x, selectionBoxPosition.y+7, brushSize+2, brushSize+2
        
        if(cellGrid[x][y]!=undefined){
          addSprite(x, y+7, cellGrid[x][y].color)
        }

        if(selectionBoxPixels.some(e=>e.x==x&&e.y==y)){
          addSprite(x, y+7, selectionBox)
        }
      }
      if(cellGrid[x][y]!=undefined){
        cellGrid[x][y].step()
      }
    }
  }
}, 0)


redrawSelectionBox()
redrawUI()
